<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>minigames-host</title>
        <link href="css/sass.css" rel="stylesheet"/>
    </head>
    <body>
        <div id="delAll">
            <div class="input-group mb-3" id="copy">
                <input type="text" readonly class="form-control"  value="" aria-describedby="button-addon2" id="inviteurl">
                <button class="btn btn-outline-primary" type="button" id="button-addon2">Copy</button>
            </div>

            <button id="startButton">Start</button>
            <p id="playerCount">Players: 0/10</p>
        </div>

        <div id="main">
            <div id="canvas">
                <canvas id="hangman" width="200" height="200"></canvas>
            </div>

            <div id="word"></div>
            <br>
            <br>
            <button id="A">A</button>
            <button id="B">B</button>
            <button id="C">C</button>
            <button id="D">D</button>
            <button id="E">E</button>
            <button id="F">F</button>
            <button id="G">G</button>
            <button id="H">H</button>
            <button id="I">I</button>
            <button id="J">J</button>
            <button id="K">K</button>
            <button id="L">L</button>
            <button id="M">M</button>
            <button id="N">N</button>
            <button id="O">O</button>
            <button id="P">P</button>
            <button id="Q">Q</button>
            <button id="R">R</button>
            <button id="S">S</button>
            <button id="T">T</button>
            <button id="U">U</button>
            <button id="V">V</button>
            <button id="W">W</button>
            <button id="X">X</button>
            <button id="Y">Y</button>
            <button id="Z">Z</button>
        </div>
        

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.socket.io/4.4.1/socket.io.min.js" integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H" crossorigin="anonymous"></script>
        <script src="js/hangman.js" type="text/javascript"></script>
        <script src="js/main.js"></script>
        
        <script type="module">
            let maxWrong = '6';

            // check if the url contains a code
            var url = window.location.href;
            var code = url.split('?code=').pop();
                    
            var nakedurl = location.protocol + '//' + location.host + location.pathname;

                    
            if (code == nakedurl) {
                var code = Math.floor(100000 + Math.random() * 900000)
                window.location.href = nakedurl+"?code="+code;
            } else {
                if (code.length != 6 || isNaN(code)) {
                    window.location.href = nakedurl;
                }
            }

            const socket = io.connect('http://localhost:3000');
            socket.on("connect", () => {

                socket.emit('roomQuery', code, 10);

                socket.on("roomFull", data => {
                    if (data == true) {
                        alert("The room you are trying to join is full");
                        window.location.href = "index.html";
                    }
                });

                socket.on("roomQueryResp", () => {
                    var main = document.getElementById("main");
                    var startBtn = document.getElementById("startButton");
                    var playerCount = document.getElementById("playerCount");
                    var inviteurl = document.getElementById("inviteurl");
                            
                    inviteurl.value = "http://127.0.0.1:5500/hangman.html?code=" + code;

                    main.style.filter = "blur(5px)";
                    var waiting = document.createElement("h1");
                    waiting.innerText = "Waiting for other player to join...";
                    document.body.appendChild(waiting);

                    socket.emit("getRoomInfo", code);
                    socket.on("roomInfo", info => {
                        if (info[2] == undefined) hostFunc();
                        if (info[2] != undefined) clientFunc();
                    });

                    var players = [];
                    function hostFunc() {
                        var testInterval = setInterval(() => {
                            socket.on("playerJoin", clientSock => {
                                if (players.includes(clientSock) != true) {
                                    players.push(clientSock);
                                    playerCount.innerText = "Players: " + players.length + "/10";
                                }
                            });

                            socket.on("playerLeave", clientSock => {
                                if (players.includes(clientSock) == true) {
                                    players.splice(players.indexOf(clientSock), 1);
                                    playerCount.innerText = "Players: " + players.length + "/10";
                                }
                            });

                            startBtn.addEventListener("click", () => {clearInterval(testInterval); exitFuncHost();});
                        }, 500);

                        function exitFuncHost() {
                            main.style.filter = "none";
                            document.getElementById("delAll").remove();

                            document.getElementById("A").onclick = function() {chooseLetter("A", "A");};
                            document.getElementById("B").onclick = function() {chooseLetter("B", "B");};
                            document.getElementById("C").onclick = function() {chooseLetter("C", "C");};
                            document.getElementById("D").onclick = function() {chooseLetter("D", "D");};
                            document.getElementById("E").onclick = function() {chooseLetter("E", "E");};
                            document.getElementById("F").onclick = function() {chooseLetter("F", "F");};
                            document.getElementById("G").onclick = function() {chooseLetter("G", "G");};
                            document.getElementById("H").onclick = function() {chooseLetter("H", "H");};
                            document.getElementById("I").onclick = function() {chooseLetter("I", "I");};
                            document.getElementById("J").onclick = function() {chooseLetter("J", "J");};
                            document.getElementById("K").onclick = function() {chooseLetter("K", "K");};
                            document.getElementById("L").onclick = function() {chooseLetter("L", "L");};
                            document.getElementById("M").onclick = function() {chooseLetter("M", "M");};
                            document.getElementById("N").onclick = function() {chooseLetter("N", "N");};
                            document.getElementById("O").onclick = function() {chooseLetter("O", "O");};
                            document.getElementById("P").onclick = function() {chooseLetter("P", "P");};
                            document.getElementById("Q").onclick = function() {chooseLetter("Q", "Q");};
                            document.getElementById("R").onclick = function() {chooseLetter("R", "R");};
                            document.getElementById("S").onclick = function() {chooseLetter("S", "S");};
                            document.getElementById("T").onclick = function() {chooseLetter("T", "T");};
                            document.getElementById("U").onclick = function() {chooseLetter("U", "U");};
                            document.getElementById("V").onclick = function() {chooseLetter("V", "V");};
                            document.getElementById("W").onclick = function() {chooseLetter("W", "W");};
                            document.getElementById("X").onclick = function() {chooseLetter("X", "X");};
                            document.getElementById("Y").onclick = function() {chooseLetter("Y", "Y");};
                            document.getElementById("Z").onclick = function() {chooseLetter("Z", "Z");};

                            loadGame();
                        }
                    }

                    function clientFunc() {
                        document.getElementById("delAll").remove();

                        document.getElementById("A").onclick = function() {chooseLetter("A", "A");};
                        document.getElementById("B").onclick = function() {chooseLetter("B", "B");};
                        document.getElementById("C").onclick = function() {chooseLetter("C", "C");};
                        document.getElementById("D").onclick = function() {chooseLetter("D", "D");};
                        document.getElementById("E").onclick = function() {chooseLetter("E", "E");};
                        document.getElementById("F").onclick = function() {chooseLetter("F", "F");};
                        document.getElementById("G").onclick = function() {chooseLetter("G", "G");};
                        document.getElementById("H").onclick = function() {chooseLetter("H", "H");};
                        document.getElementById("I").onclick = function() {chooseLetter("I", "I");};
                        document.getElementById("J").onclick = function() {chooseLetter("J", "J");};
                        document.getElementById("K").onclick = function() {chooseLetter("K", "K");};
                        document.getElementById("L").onclick = function() {chooseLetter("L", "L");};
                        document.getElementById("M").onclick = function() {chooseLetter("M", "M");};
                        document.getElementById("N").onclick = function() {chooseLetter("N", "N");};
                        document.getElementById("O").onclick = function() {chooseLetter("O", "O");};
                        document.getElementById("P").onclick = function() {chooseLetter("P", "P");};
                        document.getElementById("Q").onclick = function() {chooseLetter("Q", "Q");};
                        document.getElementById("R").onclick = function() {chooseLetter("R", "R");};
                        document.getElementById("S").onclick = function() {chooseLetter("S", "S");};
                        document.getElementById("T").onclick = function() {chooseLetter("T", "T");};
                        document.getElementById("U").onclick = function() {chooseLetter("U", "U");};
                        document.getElementById("V").onclick = function() {chooseLetter("V", "V");};
                        document.getElementById("W").onclick = function() {chooseLetter("W", "W");};
                        document.getElementById("X").onclick = function() {chooseLetter("X", "X");};
                        document.getElementById("Y").onclick = function() {chooseLetter("Y", "Y");};
                        document.getElementById("Z").onclick = function() {chooseLetter("Z", "Z");};

                        loadGame();
                    }
                });
            });
        </script>
    </body>
</html>